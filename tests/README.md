# WebSocket æµ‹è¯•å¥—ä»¶

## æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ WebSocket åœºæ™¯æµ‹è¯•å¥—ä»¶ï¼Œç”¨äºéªŒè¯ Realtime RAG WebSocket æœåŠ¡çš„æ‰€æœ‰åŠŸèƒ½ã€‚

## æµ‹è¯•åœºæ™¯

æµ‹è¯•å¥—ä»¶åŒ…å« 12 ä¸ªæµ‹è¯•åœºæ™¯ï¼Œè¦†ç›–äº† spec æ–‡æ¡£ä¸­å®šä¹‰çš„æ‰€æœ‰åŠŸèƒ½ï¼š

### åŸºç¡€åŠŸèƒ½æµ‹è¯•

1. **åœºæ™¯1: è¿æ¥å’Œåˆå§‹ç¡®è®¤**
   - æµ‹è¯• WebSocket è¿æ¥å»ºç«‹
   - éªŒè¯åˆå§‹ `ack` æ¶ˆæ¯
   - éªŒè¯ `session_id` åˆ†é…
   - éªŒè¯åˆå§‹ `listening` çŠ¶æ€

2. **åœºæ™¯2: å¿ƒè·³æ¶ˆæ¯**
   - æµ‹è¯• `keepalive` æ¶ˆæ¯
   - éªŒè¯æœåŠ¡å™¨ç¡®è®¤

3. **åœºæ™¯3: éæœ€ç»ˆåŒ– ASR æ–‡æœ¬å—**
   - æµ‹è¯• `is_final: false` çš„ ASR æ–‡æœ¬å—
   - éªŒè¯æœåŠ¡å™¨ç¼“å†²è¡Œä¸º

### é—®é¢˜æ£€æµ‹å’Œ RAG åŠŸèƒ½

4. **åœºæ™¯4: é—®é¢˜æ£€æµ‹å’Œ RAG æŸ¥è¯¢**
   - æµ‹è¯•å®Œæ•´çš„é—®é¢˜è¯†åˆ«æµç¨‹
   - éªŒè¯çŠ¶æ€è½¬æ¢ï¼ˆ`analyzing` â†’ `querying_rag`ï¼‰
   - éªŒè¯ç­”æ¡ˆæµå¼ä¼ è¾“
   - éªŒè¯è¿”å› `idle` çŠ¶æ€

5. **åœºæ™¯5: éé—®é¢˜æ–‡æœ¬**
   - æµ‹è¯•éé—®é¢˜æ–‡æœ¬çš„å¤„ç†
   - éªŒè¯ `waiting_for_question` çŠ¶æ€

### æ§åˆ¶åŠŸèƒ½

6. **åœºæ™¯6: æš‚åœå’Œæ¢å¤**
   - æµ‹è¯• `pause` æ§åˆ¶æ¶ˆæ¯
   - éªŒè¯æš‚åœçŠ¶æ€ä¸‹çš„è¡Œä¸º
   - æµ‹è¯• `resume` æ§åˆ¶æ¶ˆæ¯
   - éªŒè¯çŠ¶æ€æ¢å¤

7. **åœºæ™¯7: å³æ—¶æŸ¥è¯¢**
   - æµ‹è¯• `instant_query` åŠŸèƒ½
   - éªŒè¯å¼ºåˆ¶æŸ¥è¯¢æµç¨‹
   - éªŒè¯ `mode: instant` æ ‡è®°

8. **åœºæ™¯8: æ— æœ€ç»ˆåŒ–æ–‡æœ¬çš„å³æ—¶æŸ¥è¯¢**
   - æµ‹è¯•é”™è¯¯å¤„ç†
   - éªŒè¯ `NO_FINAL_ASR` é”™è¯¯ä»£ç 

9. **åœºæ™¯9: åœæ­¢å‘½ä»¤**
   - æµ‹è¯• `stop` æ§åˆ¶æ¶ˆæ¯
   - éªŒè¯ä¼šè¯ç»ˆæ­¢

### é”™è¯¯å¤„ç†

10. **åœºæ™¯10: æ— æ•ˆæ¶ˆæ¯**
    - æµ‹è¯•æ— æ•ˆ JSON å¤„ç†
    - éªŒè¯ `INVALID_JSON` é”™è¯¯ä»£ç 

11. **åœºæ™¯11: ä¸æ”¯æŒçš„æ¶ˆæ¯ç±»å‹**
    - æµ‹è¯•æœªçŸ¥æ¶ˆæ¯ç±»å‹å¤„ç†
    - éªŒè¯ `UNSUPPORTED_TYPE` é”™è¯¯ä»£ç 

### é«˜çº§åŠŸèƒ½

12. **åœºæ™¯12: å¤šè½®å¯¹è¯**
    - æµ‹è¯•è¿ç»­å¤šä¸ªé—®é¢˜
    - éªŒè¯ä¼šè¯çŠ¶æ€ä¿æŒ
    - éªŒè¯å¤šæ¬¡æŸ¥è¯¢æµç¨‹

## å®‰è£…ä¾èµ–

### æ–¹å¼1: ä½¿ç”¨ pip

```bash
# å®‰è£…æµ‹è¯•ä¾èµ–
pip install -r requirements-test.txt
```

### æ–¹å¼2: å•ç‹¬å®‰è£…

```bash
pip install websockets colorama
```

## è¿è¡Œæµ‹è¯•

### 1. å¯åŠ¨æœåŠ¡å™¨

é¦–å…ˆç¡®ä¿ WebSocket æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼š

```bash
# æ–¹å¼1: ä½¿ç”¨å¯åŠ¨è„šæœ¬
./run.sh

# æ–¹å¼2: ç›´æ¥è¿è¡Œ
python -m uvicorn app.main:app --reload
```

### 2. è¿è¡Œæµ‹è¯•å¥—ä»¶

åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­è¿è¡Œæµ‹è¯•ï¼š

```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
python tests/test_websocket_scenarios.py

# æˆ–ä½¿ç”¨ pytest
pytest tests/test_websocket_scenarios.py -v

# æˆ–ç›´æ¥æ‰§è¡Œ
./tests/test_websocket_scenarios.py
```

## é…ç½®

### ä¿®æ”¹ WebSocket URL

å¦‚æœæœåŠ¡å™¨è¿è¡Œåœ¨ä¸åŒçš„åœ°å€æˆ–ç«¯å£ï¼Œå¯ä»¥ä¿®æ”¹æµ‹è¯•è„šæœ¬ä¸­çš„é…ç½®ï¼š

```python
# åœ¨ test_websocket_scenarios.py ä¸­ä¿®æ”¹
WS_URL = "ws://localhost:8000/ws/realtime-asr"  # ä¿®æ”¹ä¸ºä½ çš„åœ°å€
TIMEOUT = 30  # ä¿®æ”¹è¶…æ—¶æ—¶é—´
```

### ç¯å¢ƒå˜é‡é…ç½®

ä¹Ÿå¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ï¼š

```bash
export WS_TEST_URL="ws://your-server:8000/ws/realtime-asr"
export WS_TEST_TIMEOUT=60
python tests/test_websocket_scenarios.py
```

## æµ‹è¯•è¾“å‡º

### æ­£å¸¸è¾“å‡º

æµ‹è¯•è¿è¡Œæ—¶ä¼šæ˜¾ç¤ºå½©è‰²è¾“å‡ºï¼ŒåŒ…æ‹¬ï¼š

- ğŸŸ¢ ç»¿è‰²: æˆåŠŸçš„æ“ä½œ
- ğŸ”µ è“è‰²: å‘é€çš„æ¶ˆæ¯
- ğŸŸ¡ é»„è‰²: æ¥æ”¶çš„æ¶ˆæ¯
- ğŸ”´ çº¢è‰²: é”™è¯¯æˆ–å¤±è´¥

ç¤ºä¾‹è¾“å‡ºï¼š

```
============================================================
æµ‹è¯•: åœºæ™¯4: é—®é¢˜æ£€æµ‹å’Œ RAG æŸ¥è¯¢
============================================================
âœ“ è¿æ¥æˆåŠŸ: ws://localhost:8000/ws/realtime-asr
â†’ å‘é€: {"type": "asr_chunk", "text": "ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ", "is_final": true}
â† æ¥æ”¶: {"type": "ack", "received_type": "asr_chunk", "session_id": "..."}
â† æ¥æ”¶: {"type": "status", "stage": "analyzing", "session_id": "..."}
â† æ¥æ”¶: {"type": "status", "stage": "querying_rag", "session_id": "..."}
â† æ¥æ”¶: {"type": "answer", "content": "äººå·¥æ™ºèƒ½æ˜¯...", "final": false}
...
âœ“ æµ‹è¯•é€šè¿‡ (5.23ç§’)
```

### æµ‹è¯•æ‘˜è¦

æµ‹è¯•å®Œæˆåä¼šæ˜¾ç¤ºæ‘˜è¦ï¼š

```
============================================================
æµ‹è¯•æ‘˜è¦
============================================================

âœ“ åœºæ™¯1: è¿æ¥å’Œåˆå§‹ç¡®è®¤: æµ‹è¯•é€šè¿‡ (0.15ç§’)
âœ“ åœºæ™¯2: å¿ƒè·³æ¶ˆæ¯: æµ‹è¯•é€šè¿‡ (0.12ç§’)
âœ“ åœºæ™¯3: éæœ€ç»ˆåŒ– ASR æ–‡æœ¬å—: æµ‹è¯•é€šè¿‡ (0.10ç§’)
âœ“ åœºæ™¯4: é—®é¢˜æ£€æµ‹å’Œ RAG æŸ¥è¯¢: æµ‹è¯•é€šè¿‡ (5.23ç§’)
...

æ€»è®¡: 12 ä¸ªæµ‹è¯•
é€šè¿‡: 12
å¤±è´¥: 0
è€—æ—¶: 35.67ç§’

============================================================
æ‰€æœ‰æµ‹è¯•é€šè¿‡! ğŸ‰
============================================================
```

## æ•…éšœæ’æŸ¥

### è¿æ¥å¤±è´¥

**é”™è¯¯**: `âœ— è¿æ¥å¤±è´¥: [Errno 111] Connection refused`

**è§£å†³**:
1. ç¡®è®¤æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ
2. æ£€æŸ¥ç«¯å£æ˜¯å¦æ­£ç¡®ï¼ˆé»˜è®¤ 8000ï¼‰
3. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

### æµ‹è¯•è¶…æ—¶

**é”™è¯¯**: `âœ— æ¥æ”¶è¶…æ—¶`

**è§£å†³**:
1. æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦é…ç½®äº† RAG æä¾›å•†
2. ç¡®è®¤ API å¯†é’¥é…ç½®æ­£ç¡®
3. å¢åŠ è¶…æ—¶æ—¶é—´ï¼ˆä¿®æ”¹ `TIMEOUT` å˜é‡ï¼‰

### RAG æŸ¥è¯¢å¤±è´¥

**é”™è¯¯**: æµ‹è¯•åœºæ™¯4å¤±è´¥

**è§£å†³**:
1. æ£€æŸ¥ `.env` æ–‡ä»¶é…ç½®
2. éªŒè¯ RAG æä¾›å•† API å¯†é’¥
3. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—äº†è§£è¯¦ç»†é”™è¯¯

### å¯¼å…¥é”™è¯¯

**é”™è¯¯**: `ModuleNotFoundError: No module named 'websockets'`

**è§£å†³**:
```bash
pip install -r requirements-test.txt
```

## è‡ªå®šä¹‰æµ‹è¯•

### æ·»åŠ æ–°çš„æµ‹è¯•åœºæ™¯

```python
async def test_my_custom_scenario():
    """è‡ªå®šä¹‰æµ‹è¯•åœºæ™¯"""
    client = WebSocketTestClient()
    
    # 1. è¿æ¥
    if not await client.connect():
        return False
    
    # 2. è·³è¿‡åˆå§‹æ¶ˆæ¯
    await client.wait_for_message_type("ack")
    await client.wait_for_status("listening")
    
    # 3. æ‰§è¡Œä½ çš„æµ‹è¯•é€»è¾‘
    await client.send_message({
        "type": "asr_chunk",
        "text": "ä½ çš„æµ‹è¯•æ–‡æœ¬",
        "is_final": True
    })
    
    # 4. éªŒè¯ç»“æœ
    # ...
    
    # 5. æ–­å¼€è¿æ¥
    await client.disconnect()
    return True

# åœ¨ main() å‡½æ•°ä¸­æ·»åŠ 
await tester.run_test("è‡ªå®šä¹‰åœºæ™¯", test_my_custom_scenario)
```

### æŸ¥çœ‹æ¶ˆæ¯æ—¥å¿—

åœ¨æµ‹è¯•å‡½æ•°ä¸­è°ƒç”¨ `client.print_message_log()` å¯ä»¥æŸ¥çœ‹å®Œæ•´çš„æ¶ˆæ¯äº¤äº’å†å²ã€‚

## æŒç»­é›†æˆ

### GitHub Actions

```yaml
name: WebSocket Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.9'
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-test.txt
      - name: Start server
        run: |
          python -m uvicorn app.main:app &
          sleep 5
      - name: Run tests
        run: python tests/test_websocket_scenarios.py
```

## æ€§èƒ½åŸºå‡†

### é¢„æœŸæ€§èƒ½æŒ‡æ ‡

- è¿æ¥å»ºç«‹: < 100ms
- å¿ƒè·³å“åº”: < 50ms
- é—®é¢˜æ£€æµ‹: < 50ms
- RAG æŸ¥è¯¢: 2-5ç§’ï¼ˆå–å†³äºæä¾›å•†ï¼‰
- ç­”æ¡ˆæµå¼ä¼ è¾“: < 100ms/å—

### ç›‘æ§æ€§èƒ½

æµ‹è¯•ç»“æœä¼šæ˜¾ç¤ºæ¯ä¸ªåœºæ™¯çš„æ‰§è¡Œæ—¶é—´ï¼Œå¯ä»¥ç”¨äºç›‘æ§æ€§èƒ½å˜åŒ–ã€‚

## è´¡çŒ®

æ¬¢è¿è´¡çŒ®æ–°çš„æµ‹è¯•åœºæ™¯ï¼è¯·ç¡®ä¿ï¼š

1. æµ‹è¯•åœºæ™¯æœ‰æ¸…æ™°çš„æè¿°
2. åŒ…å«å®Œæ•´çš„éªŒè¯é€»è¾‘
3. æ­£ç¡®å¤„ç†é”™è¯¯æƒ…å†µ
4. éµå¾ªç°æœ‰çš„ä»£ç é£æ ¼

## ç›¸å…³æ–‡æ¡£

- [WebSocket åè®®è§„èŒƒ](../spec/protocols/realtime-websocket.md)
- [API å‚è€ƒæ–‡æ¡£](../spec/api-reference.md)
- [é¡¹ç›® README](../README.md)

## è®¸å¯è¯

MIT License


